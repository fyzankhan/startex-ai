name: Deploy Flask App - Remote Build (Py 3.12)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Keep the deploy artifact small: source only (no venv/site-packages)
      - name: Package source (no venv)
        run: |
          zip -r release.zip . \
            -x ".git/*" ".github/*" \
               "venv/*" ".venv/*" "antenv/*" \
               "site-packages/*" "__pycache__/*" \
               "**/*.pyc" "**/*.pyo" "node_modules/*"

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_333CECB667CA4A17B6BBFF55B137D939 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_8FFF437F240744D69368AB119E60ED44 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_5CFC7011C380498797D4360D9B4CE671 }}

      # Set runtime + app settings + startup command (auto-detect RG)
      - name: Ensure App Service stack/app settings (Py 3.12)
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail
            APP="flask-ai"

            # Find the resource group for this app
            RG="$(az webapp list --query "[?name=='${APP}'].resourceGroup" -o tsv)"
            if [ -z "$RG" ]; then
              echo "❌ Could not resolve resource group for app '${APP}'.";
              exit 1
            fi
            echo "✅ Resolved resource group: $RG"

            # 1) Force Linux Python 3.12 runtime
            az webapp config set \
              --name "$APP" \
              --resource-group "$RG" \
              --linux-fx-version "PYTHON|3.12"

            # 2) App settings:
            #    - Remote build (Oryx installs from requirements.txt once)
            #    - Run From Package (mount ZIP, avoids unzip disk spikes)
            #    - PORT=8090 (your app listens here; Gunicorn binds to ${PORT})
            az webapp config appsettings set \
              --name "$APP" \
              --resource-group "$RG" \
              --settings \
                SCM_DO_BUILD_DURING_DEPLOYMENT=true \
                WEBSITE_RUN_FROM_PACKAGE=1 \
                PORT=8090

            # 3) Set startup command for Linux containers
            #    Use 'main:app' if your entry file is main.py; here we assume app.py -> app
            az webapp config set \
              --name "$APP" \
              --resource-group "$RG" \
              --startup-file "gunicorn --bind=0.0.0.0:\${PORT} app:app"

      - name: Deploy ZIP (Remote Build)
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'flask-ai'
          slot-name: 'Production'
          package: release.zip

      # Warm up once so first user hit isn't a cold start
      - name: Warm up app
        run: |
          sleep 10
          curl -I --max-time 25 https://flask-ai-andse2apc9frd8dp.southindia-01.azurewebsites.net || true
