name: Deploy Flask App - Remote Build (Py 3.12)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Small source-only ZIP so OneDeploy doesnâ€™t timeout
      - name: Package source (no venv)
        run: |
          zip -r release.zip . \
            -x ".git/*" ".github/*" \
               "venv/*" ".venv/*" "antenv/*" \
               "site-packages/*" "__pycache__/*" \
               "*.pyc" "*.pyo" "node_modules/*"

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_333CECB667CA4A17B6BBFF55B137D939 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_8FFF437F240744D69368AB119E60ED44 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_5CFC7011C380498797D4360D9B4CE671 }}

      # Enforce Python 3.12 + App Settings BEFORE deploy
      - name: Ensure App Service stack/app settings
        uses: azure/cli@v2
        with:
          inlineScript: |
            APP=flask-ai
            RG=$(az webapp show --name $APP --query resourceGroup -o tsv)

            # Set stack to Python 3.12 (Linux)
            az webapp config set \
              --name $APP \
              --resource-group $RG \
              --linux-fx-version "PYTHON|3.12"

            # App settings for reliable deploy/run
            az webapp config appsettings set \
              --name $APP \
              --resource-group $RG \
              --settings \
                SCM_DO_BUILD_DURING_DEPLOYMENT=true \
                WEBSITE_RUN_FROM_PACKAGE=1 \
                PORT=8090

            # Optional: keep site warm (AlwaysOn recommended in portal)

      - name: Deploy ZIP (Remote Build)
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'flask-ai'
          slot-name: 'Production'
          package: release.zip

      # Warm-up: hit the site once so gunicorn boots
      - name: Warm up app
        run: |
          sleep 10
          curl -I --max-time 25 https://flask-ai-andse2apc9frd8dp.southindia-01.azurewebsites.net || true
